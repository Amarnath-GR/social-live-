import '../services/api_client.dart';

class CommentsService {
  static final ApiClient _apiClient = ApiClient();

  static Future<Map<String, dynamic>> getComments(String postId, {int page = 1, int limit = 20}) async {
    try {
      final response = await _apiClient.get('/comments/post/$postId', queryParameters: {
        'page': page,
        'limit': limit,
      });

      // Backend returns { comments: [...], pagination: {...} }
      if (response.data != null) {
        final data = response.data;
        List<Map<String, dynamic>> comments = [];
        
        // Handle direct response format from backend
        if (data['comments'] != null) {
          comments = List<Map<String, dynamic>>.from(data['comments']);
        } else if (data is List) {
          comments = List<Map<String, dynamic>>.from(data);
        } else if (data['data'] != null) {
          if (data['data'] is List) {
            comments = List<Map<String, dynamic>>.from(data['data']);
          } else if (data['data']['comments'] != null) {
            comments = List<Map<String, dynamic>>.from(data['data']['comments']);
          }
        }
        
        // Check pagination info
        final pagination = data['pagination'];
        final hasMore = pagination != null 
            ? (pagination['page'] < pagination['totalPages']) 
            : false;
        
        return {
          'success': true,
          'comments': comments,
          'hasMore': hasMore,
        };
      }
      
      return {'success': false, 'message': 'Failed to load comments'};
    } catch (e) {
      print('Error loading comments: $e');
      return {'success': false, 'message': 'Network error: ${e.toString()}'};
    }
  }

  static Future<Map<String, dynamic>> addComment(String postId, String content) async {
    try {
      // Backend expects POST to /comments/post/:postId with content in body
      final response = await _apiClient.post('/comments/post/$postId', data: {
        'content': content,
      });

      // Backend returns the comment object directly
      if (response.data != null) {
        return {
          'success': true,
          'comment': response.data,
        };
      }
      
      return {'success': false, 'message': 'Failed to add comment'};
    } catch (e) {
      print('Error adding comment: $e');
      return {'success': false, 'message': 'Network error: ${e.toString()}'};
    }
  }

  static Future<Map<String, dynamic>> deleteComment(String commentId) async {
    try {
      final response = await _apiClient.delete('/comments/$commentId');
      return {
        'success': response.data['success'] ?? false,
        'message': response.data['message'] ?? '',
      };
    } catch (e) {
      return {'success': false, 'message': 'Failed to delete comment'};
    }
  }
}
